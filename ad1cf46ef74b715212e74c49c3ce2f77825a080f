{
  "comments": [
    {
      "key": {
        "uuid": "58954f2c_95784439",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T04:48:59Z",
      "side": 1,
      "message": "Should we add a line after this to explain WHY this is necessary?",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 72
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4be757ad_ac98b86e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T07:33:05Z",
      "side": 1,
      "message": "Yes, let me add it.",
      "parentUuid": "58954f2c_95784439",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 72
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "44e1f7fa_57eab12e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T20:41:47Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4be757ad_ac98b86e",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 72
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bc7f05be_3e71f0f8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T04:48:59Z",
      "side": 1,
      "message": "Is this a TODO or simply a NOTE?\nIf is a TODO, should be captured by a ticket/CR?",
      "range": {
        "startLine": 11,
        "startChar": 0,
        "endLine": 13,
        "endChar": 42
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c38f760e_755af92a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T07:33:05Z",
      "side": 1,
      "message": "I\u0027ll amend to \"Future work\". It\u0027s not a TODO for this change, but definitely something to look for in the near future. It may require a change in the replication plugin though.",
      "parentUuid": "bc7f05be_3e71f0f8",
      "range": {
        "startLine": 11,
        "startChar": 0,
        "endLine": 13,
        "endChar": 42
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ab9c95ec_2772c8f8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T20:41:47Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c38f760e_755af92a",
      "range": {
        "startLine": 11,
        "startChar": 0,
        "endLine": 13,
        "endChar": 42
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7c8c6cb3_e074b68e",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 63,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T04:48:59Z",
      "side": 1,
      "message": "I think flushing might be misleading, as this is not just flushing the list of accounts, but it is also performing the indexing for each one, and then flushing.\n\nto me doIndex() or similar would represent more the intent of the method",
      "range": {
        "startLine": 63,
        "startChar": 27,
        "endLine": 63,
        "endChar": 32
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b6036fbc_6c3bccea",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 63,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T07:33:05Z",
      "side": 1,
      "message": "runAsyncIndexAndFlush?",
      "parentUuid": "7c8c6cb3_e074b68e",
      "range": {
        "startLine": 63,
        "startChar": 27,
        "endLine": 63,
        "endChar": 32
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e6e609d7_fa2c5737",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 63,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T16:41:46Z",
      "side": 1,
      "message": "yep, better name IMHO",
      "parentUuid": "b6036fbc_6c3bccea",
      "range": {
        "startLine": 63,
        "startChar": 27,
        "endLine": 63,
        "endChar": 32
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b919c14d_569ab5b7",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 65,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T04:48:59Z",
      "side": 1,
      "message": "What happens when an indexing fails after some succeeded?\nShould we not update the map as each index is fired?\nso that already indexed accounts are removed from the queue even in case of a subsequent failure?",
      "range": {
        "startLine": 65,
        "startChar": 2,
        "endLine": 65,
        "endChar": 68
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ccee4757_8384a2e3",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 65,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T07:33:05Z",
      "side": 1,
      "message": "\u003e What happens when an indexing fails after some succeeded?\n\u003e Should we not update the map as each index is fired?\n\u003e so that already indexed accounts are removed from the queue even in case of a subsequent failure?\n\nGood catch, we should log the failure and keep on indexing the others.",
      "parentUuid": "b919c14d_569ab5b7",
      "range": {
        "startLine": 65,
        "startChar": 2,
        "endLine": 65,
        "endChar": 68
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7592eda3_30e8869c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/ForwardedIndexAccountHandler.java",
        "patchSetId": 2
      },
      "lineNbr": 65,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T20:41:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ccee4757_8384a2e3",
      "range": {
        "startLine": 65,
        "startChar": 2,
        "endLine": 65,
        "endChar": 68
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b60a70da_bda860bb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/router/IndexEventRouter.java",
        "patchSetId": 2
      },
      "lineNbr": 92,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T04:48:59Z",
      "side": 1,
      "message": "I am not sure I understand this logic:\nWhen would `accountId` be null?\nAnd why do we trigger the indexing of buffered accounts when we received a replication event that doesn\u0027t carry any account information?\n\nCould you clarify which events are expected to be associated to which actions?",
      "range": {
        "startLine": 88,
        "startChar": 1,
        "endLine": 92,
        "endChar": 7
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d31950fa_bd038536",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/router/IndexEventRouter.java",
        "patchSetId": 2
      },
      "lineNbr": 92,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T07:33:05Z",
      "side": 1,
      "message": "\u003e I am not sure I understand this logic:\n\u003e When would `accountId` be null?\n\nAccording to the fromRef() method, this is when the ref-name is not specific to any account.\n\n\u003e And why do we trigger the indexing of buffered accounts when we received a replication event that doesn\u0027t carry any account information?\n\nBecause we have no clue of *what* has changed (e.g. refs/meta/external-ids) and thus the only thing that it can be possibly have changed are the accounts to be reindexed.\n\n\u003e Could you clarify which events are expected to be associated to which actions?\n\nThere is no clue at the moment carried over by this ref-replication-done: this is because the All-Users.git design have put *ALL* accounts into a single ref, which was not a scalable design for the multi-site use-case.\n\nAt the moment, this is all we can do with the current design: \"guessing\" what to do :-(",
      "parentUuid": "b60a70da_bda860bb",
      "range": {
        "startLine": 88,
        "startChar": 1,
        "endLine": 92,
        "endChar": 7
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "aa283622_596b5bd1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/router/IndexEventRouter.java",
        "patchSetId": 2
      },
      "lineNbr": 92,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2020-02-05T16:41:46Z",
      "side": 1,
      "message": "If I understand this correctly we will only be triggering the account reindexes (i.e. the flush), *if* we receive a message that doesn\u0027t carry any specific account information (e.g. refs/meta/external-ids has changed).\n\nIs that message ever guaranteed to arrive?\nwhat if that message never arrives, can accounts to be reindexed grow unbound?\n\nShould we have a safe mechanism, where we trigger the flush anyway after a certain condition is met?",
      "parentUuid": "d31950fa_bd038536",
      "range": {
        "startLine": 88,
        "startChar": 1,
        "endLine": 92,
        "endChar": 7
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "21f02189_f6940a9d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/forwarder/router/IndexEventRouter.java",
        "patchSetId": 2
      },
      "lineNbr": 92,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-02-05T20:41:26Z",
      "side": 1,
      "message": "\u003e If I understand this correctly we will only be triggering the account reindexes (i.e. the flush), *if* we receive a message that doesn\u0027t carry any specific account information (e.g. refs/meta/external-ids has changed).\n\u003e \n\u003e Is that message ever guaranteed to arrive?\n\nWe receive that message through Kafka, so it *will arrive*.\nHowever, the problem is that if one of the nodes is unreachable, the message is not coming through until all the nodes are back online.\n\n\u003e what if that message never arrives, can accounts to be reindexed grow unbound?\n\nNever, NO. Eventually, yes.\nThe problem is that this list is kept in memory, so if Gerrit restarts *before* it gets the replication-done event, the list of accounts to reindex is lost.\n\n\u003e Should we have a safe mechanism, where we trigger the flush anyway after a certain condition is met?\n\nYes, good idea.\nWhat would be the conditions?\n\n- Timeout?\n- Before shutdown?",
      "parentUuid": "aa283622_596b5bd1",
      "range": {
        "startLine": 88,
        "startChar": 1,
        "endLine": 92,
        "endChar": 7
      },
      "revId": "ad1cf46ef74b715212e74c49c3ce2f77825a080f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}