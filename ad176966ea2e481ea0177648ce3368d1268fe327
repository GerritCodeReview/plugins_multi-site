{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "3441bdfd_9b2e4bdf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-27T13:49:56Z",
      "side": 1,
      "message": "Depends on \n\nhttps://gerrit-review.googlesource.com/c/modules/events-broker/+/312853\n\nand the publishing of the related artifact",
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8be3e6b8_6bb51b89",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-27T13:58:06Z",
      "side": 1,
      "message": "@luca, @Marcin, @Ponch.\nThe moving of the stream events publishing logic to the events-broker implies that all implementations are equals.\n\nHowever multi-site at the moment has its own implementation of the gerrit event streaming handling, which only publishes a subset of all gerrit events.\n\nThis is in contrast with the current events-broker implementation, which *add* to this logic and publish all messages, unfiltered.\n\nI think it would be useful to have a quick catch up to:\n\n- Understand if moving the stream events publishing logic to events-broker actually makes sense.\n\n- Understand if (currently, even before this CR), multi-site does the right thing, because it seems to me that:\n   * some events might be published twice\n   * some events that are not supposed to be streamed to other masters are streamed anyway (due to the blind implementation of the brokers).\n\n[1] https://gerrit.googlesource.com/plugins/multi-site/+/ad176966ea2e481ea0177648ce3368d1268fe327/src/main/java/com/googlesource/gerrit/plugins/multisite/event/EventHandler.java#46",
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0e095be6_776d6a0a",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/event/EventModule.java",
        "patchSetId": 1
      },
      "lineNbr": 38,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-27T13:58:06Z",
      "side": 1,
      "message": "Note to self:\nBefore merging this change, different EventListener need to be removed from kinesis, gcloud and kafka implementation.",
      "range": {
        "startLine": 38,
        "startChar": 1,
        "endLine": 38,
        "endChar": 30
      },
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c41c5a14_1198bf06",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/event/EventModule.java",
        "patchSetId": 1
      },
      "lineNbr": 45,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-07-27T14:26:16Z",
      "side": 1,
      "message": "That\u0027s not the right topic, events-* plugins sending events to `gerrit` topic and this will be resolved by default to `GERRIT.EVENT.STREAM` in that cache both StreamEventPublisher and EventHandler will publish to the same topic. Two issues with that:\n1. We will duplicate messages\n2. EventHandler is filtering events using global/local projects feature but now all events will be propagated",
      "range": {
        "startLine": 45,
        "startChar": 20,
        "endLine": 45,
        "endChar": 70
      },
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bea563f7_ce097908",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/event/EventModule.java",
        "patchSetId": 1
      },
      "lineNbr": 45,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-27T14:56:08Z",
      "side": 1,
      "message": "\u003e That\u0027s not the right topic,\n\nI find it a bit confusing that the STREAM_EVENT_TOPIC is not the right topic for sending stream events ðŸ˜Š\n\nBut I guess this part is the inconsistency we are trying to solve.\n\nDo we actually need to add *another* topic configuration to multi-site?\nI was thinking that after removing the publishing of the\n stream events from the events-* broker, we will just need *one* topic and not two anymore right?\nCan we not use this one for that purpose?\n\n\u003e events-* plugins sending events to `gerrit` topic and this will be resolved by default to `GERRIT.EVENT.STREAM` in that cache both StreamEventPublisher and EventHandler will publish to the same topic. Two issues with that:\n\u003e 1. We will duplicate messages\n\nI thought the plan was to remove remove the sending of the events from the events-* broker. is that not the case?\n\n\u003e 2. EventHandler is filtering events using global/local projects feature but now all events will be propagated\n\nYes, this is what we should be discussing about tomorrow I believe.\nWe are thinking to centralize the streaming of the events, however multi-site does something quite custom there, perhaps it is not the best candidate to use common logic.",
      "parentUuid": "c41c5a14_1198bf06",
      "range": {
        "startLine": 45,
        "startChar": 20,
        "endLine": 45,
        "endChar": 70
      },
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68c36381_920ed507",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/event/EventModule.java",
        "patchSetId": 1
      },
      "lineNbr": 45,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-07-28T16:10:36Z",
      "side": 1,
      "message": "According to the discussion we had this morning to keep the same functionality as we have now StreamEventPublisher should publish to `gerrit` topic. As a follow up we will move global projects filtering from producer to consumers and the we can get rid of the EventHandler and StreamEventPublish can send events to STREAM_EVENT_TOPIC.\n\nWe could leave StreamEventPublisher to publish to STREAM_EVENT_TOPIC because no one is using global projects but then we will have the same events twice so it must be handled by consumers twice",
      "parentUuid": "bea563f7_ce097908",
      "range": {
        "startLine": 45,
        "startChar": 20,
        "endLine": 45,
        "endChar": 70
      },
      "revId": "ad176966ea2e481ea0177648ce3368d1268fe327",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}