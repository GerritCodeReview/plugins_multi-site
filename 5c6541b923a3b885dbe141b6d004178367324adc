{
  "comments": [
    {
      "key": {
        "uuid": "52db972e_ec07fb25",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-01-15T13:08:07Z",
      "side": 1,
      "message": "This is the first attempt to \"force\" all the updates to be BatchRefUpdate...It is still a draft but it shows you the direction I am trying to take.\n\nCan you think of any better way of doing it?",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "faebdb7f_0467108e",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2020-01-17T20:13:34Z",
      "side": 1,
      "message": "I had a look how replication plugin is receiving refs to update and I have notice that we have GitReferenceUpdatedListener interface, you can register your implementation to receive all ref updates and store newest one. With this approach you don\u0027t have to amend any commands. Maybe it\u0027s worth to explore. WDYT?",
      "parentUuid": "52db972e_ec07fb25",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "25c39ea6_a7675b02",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-01-20T08:55:14Z",
      "side": 1,
      "message": "Mmm..not sure it will work since the update of the ref and the version need to be transactional. `onGitReferenceUpdated` is only triggered when the ref update as already happened as fare as I can tell.",
      "parentUuid": "faebdb7f_0467108e",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2951a7fc_893f5ee0",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2020-01-20T11:36:59Z",
      "side": 1,
      "message": "But why it must be transactional? We do not need transaction when we do replication which I believe is more important to be in sync and to make sure that we are not loosing anything. I understand that in perfect world this would be in transaction but in real world I believe we can be few milliseconds behind.",
      "parentUuid": "25c39ea6_a7675b02",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b9cc4654_6fc85eae",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-01-20T12:05:58Z",
      "side": 1,
      "message": "By transactional I meant that in a BatchRefUpdate if an update fails, the whole batch of commands is marked a failed. I believe it is important that the ref update and its version update happens transactionally.",
      "parentUuid": "2951a7fc_893f5ee0",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "40e082a6_ba801d72",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2020-01-20T12:09:39Z",
      "side": 1,
      "message": "But then onGitReferenceUpdated is not gonna be called so the version is not going to be updated. I believe ref update should be a very quick operation that\u0027s why we should keep it as small as possible and all additional operations should be done in the listener.",
      "parentUuid": "b9cc4654_6fc85eae",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "85068e49_12f9fedd",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/multisite/validation/MultiSiteRefUpdate.java",
        "patchSetId": 5
      },
      "lineNbr": 114,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-01-20T15:50:46Z",
      "side": 1,
      "message": "Marcin is right: we don\u0027t need transactions here, because the versioning is only for keeping track where we are and expose a metric of the difference between the local version and the global one in the shared ref-db.",
      "parentUuid": "40e082a6_ba801d72",
      "range": {
        "startLine": 100,
        "startChar": 4,
        "endLine": 114,
        "endChar": 5
      },
      "revId": "5c6541b923a3b885dbe141b6d004178367324adc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}